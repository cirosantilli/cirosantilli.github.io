<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>nodejs/sequelize/raw/parallel_update_async.js - Ciro Santilli</title>
<meta property="og:title" content="nodejs/sequelize/raw/parallel_update_async.js - Ciro Santilli">
<meta property="og:type" content="website">
<meta property="og:image" content="https://raw.githubusercontent.com/cirosantilli/media/master/ID_photo_of_Ciro_Santilli_taken_in_2013_square_398.jpg">
<meta property="og:url" content="https://cirosantilli.com/_file/nodejs/sequelize/raw/parallel_update_async.js">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.1/css/all.min.css" integrity="sha512-9my9Mb2+0YO+I4PUCSwUYO7sEK21Y0STBAiFEYoWtd2VzLEZZ4QARDrZ30hdM1GlioHJ8o8cWQiy8IAb1hy/Hg==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link rel="canonical" href="https://ourbigbook.com/cirosantilli/_file/nodejs/sequelize/raw/parallel_update_async.js">
<style>@import "../../../../_obb/dist/ourbigbook.css";

</style>
<link rel="stylesheet" type="text/css" href="../../../../_raw/main.css">
<link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/cirosantilli/media/master/ID_photo_of_Ciro_Santilli_taken_in_2013_square_398.jpg">
</head>
<body>
<header>
<div class="brand-group">
<a href="../../../../" class="brand"><img src="https://raw.githubusercontent.com/cirosantilli/media/master/ID_photo_of_Ciro_Santilli_taken_in_2013_right_eye_200_100.jpg" loading="lazy" alt="ID photo of Ciro Santilli taken in 2013 right eye">Ciro Santilli</a>
<a href="https://ourbigbook.com/cirosantilli"><img src="https://raw.githubusercontent.com/cirosantilli/media/master/ourbigbook-logo-v1.svg" loading="lazy" alt="OurBigBook logo">OurBigBook.com</a>
<a class="font-awesome-container" href="https://stackoverflow.com/users/895245"><i class="fab fa-stack-overflow fa-fw icon"></i></a>
<a class="font-awesome-container" href="https://github.com/cirosantilli"><i class="fab fa-github fa-fw icon"></i></a>
<a class="font-awesome-container" href="https://www.linkedin.com/in/cirosantilli"><i class="fab fa-linkedin fa-fw icon"></i></a>
<a class="font-awesome-container" href="https://www.youtube.com/c/CiroSantilli"><i class="fab fa-youtube fa-fw icon"></i></a>
<a class="font-awesome-container" href="https://twitter.com/cirosantilli"><i class="fab fa-twitter fa-fw icon"></i></a>
<a class="font-awesome-container" href="https://www.zhihu.com/people/cirosantilli/activities"><i class="fab fa-zhihu fa-fw icon"></i></a>
<a class="font-awesome-container" href="https://www.weibo.com/p/1005055601627311"><i class="fab fa-weibo fa-fw icon"></i></a>
<a href="../../../../sponsor"><span class="icon">$£</span>&nbsp;Sponsor</a>
<a href="https://github.com/cirosantilli/china-dictatorship"><span class="icon">中国</span>独裁统治&nbsp;China Dictatorship 新疆改造中心、六四事件、法轮功、郝海东、709大抓捕、2015巴拿马文件 邓家贵、低端人口、西藏骚乱</a>
</div>
</header>
<main class="ourbigbook">
<div class="h top" id="_file/nodejs/sequelize/raw/parallel_update_async.js"><div class="notnav"><span class="file" title="This article is about a file." /><h1><a href="">nodejs/sequelize/raw/parallel_update_async.js</a></h1></div><nav class="h-nav h-nav-toplevel"><div class="nav ancestors"><a  href="#_ancestors">&nbsp;...</a><a href="../../../../sql"> SQL</a><a href="../../../../sql#sql-feature"> SQL feature</a><a href="../../../../sql#sql-transaction"> SQL transaction</a><a href="../../../../sql#sql-transaction-isolation-level"> SQL transaction isolation level</a><a href="../../../../sql#sql-isolation-level-example"> SQL isolation level example</a><a href="../../../../sql#sql-parallel-update-example"> SQL parallel update example</a></div><div class="nav"><a href="https://ourbigbook.com/cirosantilli/_file/nodejs/sequelize/raw/parallel_update_async.js"><img src="../../../../_obb/logo.svg" class="logo" alt=""> OurBigBook.com</a><a class="nosplit" href="../../../../sql#_file/nodejs/sequelize/raw/parallel_update_async.js"></a><span class="metrics"><span class="wcntr"> Words: 227</span></span></div><div class="nav file"><b> <a href="../../../../_dir">(root)</a> / <a href="../../../../_dir/nodejs">nodejs</a> / <a href="../../../../_dir/nodejs/sequelize">sequelize</a> / <a href="../../../../_dir/nodejs/sequelize/raw">raw</a> / <a href="../../../../_raw/nodejs/sequelize/raw/parallel_update_async.js">parallel_update_async.js</a></b></div></nav></div><div class="p" id="_517"><a href="../../../../_raw/nodejs/sequelize/raw/parallel_update_worker_threads.js">nodejs/sequelize/raw/parallel_update_worker_threads.js</a> contains a base example that can be used to test what can happen when queries are being run in parallel. But it is broken due to a <a href="../../../../sql#sqlite3-node-js-package"><code>sqlite3</code> Node.js package</a> bug: <a href="https://github.com/mapbox/node-sqlite3/issues/1381">github.com/mapbox/node-sqlite3/issues/1381</a>...</div><div class="p" id="_518"><a href="../../../../_raw/nodejs/sequelize/raw/parallel_update_async.js">nodejs/sequelize/raw/parallel_update_async.js</a> is an <a href="../../../../programming-language#async-javascript"><code>async</code></a> version of it. It should be just parallel enough to allow observing the same effects.</div><div class="p" id="_519">This is an example of a transaction where the <a href="../../../../sql#sql-read-committed-isolation-level">SQL READ COMMITTED isolation level</a> if sufficient.</div><div class="p" id="_520">These examples run queries of type:<div class="code" id="_521"><div><pre><code>UPDATE "MyInt" SET i = i + 1</code></pre></div></div></div><div class="p" id="_522">Sample execution:<div class="code" id="_523"><div><pre><code>node --unhandled-rejections=strict ./parallel_update_async.js p 10 100</code></pre></div></div>which does:<div class="list"><ul id="_524"><li id="_525"><a href="../../../../sql#postgresql">PostgreSQL</a>, see other databases options at <a href="../../../../sql#sql-example">SQL example</a></li><li id="_526">10 threads</li><li id="_527">100 increments on each thread</li></ul></div></div><div class="p" id="_528">The fear then is that of a classic <a href="../../../../computer#read-modify-write">read-modify-write</a> failure.</div><div class="p" id="_529">But as <a href="https://www.postgresql.org/docs/14/transaction-iso.html">www.postgresql.org/docs/14/transaction-iso.html</a> page makes very clear, including with an explicit example of type <code>UPDATE accounts SET balance = balance + 100.00 WHERE acctnum = 12345;</code>, that the default isolation level, <a href="../../../../sql#sql-read-committed-isolation-level">SQL READ COMMITTED isolation level</a>, already prevents any problems with this, as the update always re-reads selected rows in case they were previously modified.<div><blockquote id="_530">If the first updater commits, the second updater will ignore the row if the first updater deleted it, otherwise it will attempt to apply its operation to the updated version of the row</blockquote></div></div><div class="p" id="_531">Since in <a href="../../../../sql#postgresql">PostgreSQL</a> "Read uncommitted" appears to be effectively the same as "Read committed", we won't be able to observe any failures on that database system for this example.</div><div class="p" id="_532"><a href="../../../../sql#_file/nodejs/sequelize/raw/parallel_create_delete_empty_tag.js">nodejs/sequelize/raw/parallel_create_delete_empty_tag.js</a> contains an example where things can actually blow up in read committed.</div><div class="p"><b>nodejs/sequelize/raw/parallel_update_async.js</b></div><div class="code"><div><pre><code>#!/usr/bin/env node

// https://cirosantilli.com/file/sequelize/raw/parallel_update_async.js

const assert = require('assert');
const common = require('../common');

async function inc(sequelize, n) {
  for (let i = 0; i &lt; n; i++) {
    await sequelize.query(`UPDATE "MyInt" SET i = i + 1`)
  }
}

// CLI arguments.
let nthreads;
if (process.argv.length &gt; 3) {
  nthreads = parseInt(process.argv[3], 10)
} else {
  nthreads = 2;
}
let n;
if (process.argv.length &gt; 4) {
  n = parseInt(process.argv[4], 10)
} else {
  n = 10;
}

const sequelizes = common.sequelizes(nthreads, __filename, process.argv[2])
const sequelize = sequelizes[0]
;(async () =&gt; {
await common.drop(sequelize, 'MyInt')
await sequelize.query(`CREATE TABLE "MyInt" ( i INTEGER NOT NULL)`)
await sequelize.query(`INSERT INTO "MyInt" VALUES (0)`)
const arr = []
for (let i = 0; i &lt; nthreads; i++) {
  arr.push(inc(sequelizes[i], n))
}
await Promise.all(arr)
;[rows, meta] = await sequelize.query(`SELECT * FROM "MyInt"`)
assert.strictEqual(rows[0].i, nthreads * n)
})().finally(() =&gt; {
  return Promise.all(sequelizes.map(s =&gt; s.close()))
});
</code></pre></div></div><h2 id="_ancestors"><a href="#_ancestors"><span class="fa-solid-900 icon"></span> Ancestors <span class="meta">(16)</span></a></h2><div class="list"><ol><li><a href="../../../../sql#sql-parallel-update-example">SQL parallel update example</a></li><li><a href="../../../../sql#sql-isolation-level-example">SQL isolation level example</a></li><li><a href="../../../../sql#sql-transaction-isolation-level">SQL transaction isolation level</a></li><li><a href="../../../../sql#sql-transaction">SQL transaction</a></li><li><a href="../../../../sql#sql-feature">SQL feature</a></li><li><a href="../../../../sql">SQL</a></li><li><a href="../../../../software#relational-database-management-system">Relational database management system</a></li><li><a href="../../../../software#relational-database">Relational database</a></li><li><a href="../../../../software#type-of-database">Type of database</a></li><li><a href="../../../../software#database">Database</a></li><li><a href="../../../../software">Software</a></li><li><a href="../../../../computer">Computer</a></li><li><a href="../../../../technology#information-technology">Information technology</a></li><li><a href="../../../../technology#area-of-technology">Area of technology</a></li><li><a href="../../../../technology">Technology</a></li><li><a href="../../../.."><span title="Home" class="fa-solid-900 icon"></span> Home</a></li></ol></div><h2 id="_incoming-links"><a href="#_incoming-links"><span title="Incoming links" class="fa-solid-900 icon"></span> Incoming links <span class="meta">(2)</span></a></h2><div class="list"><ul><li><a href="../../../../sql#_file/nodejs/sequelize/raw/parallel_select_and_update.js">nodejs/sequelize/raw/parallel_select_and_update.js</a></li><li><a href="../../../../sql#sql-read-committed-isolation-level">SQL READ COMMITTED isolation level</a></li></ul></div>
</main>
<footer>
<div>Powered by <a href="https://docs.ourbigbook.com">OurBigBook</a></div>
<div>License: <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> unless noted</div>
<div><a href="https://github.com/cirosantilli/cirosantilli.github.io/issues">Suggestions and corrections</a></div>
<div><a href="../../../../contact">Contact Ciro Santilli</a></div>
<div><a href="../../../../_dir">Website source code</a></div>
<div><a href="https://github.com/cirosantilli/cirosantilli.github.io">Website source code on GitHub</a></div>
<div><a href="../../../../_file/sql.bigb">Source code for this page: sql.bigb</a></div>
<div><a href="https://github.com/cirosantilli/cirosantilli.github.io/blob/a4d833d32a963800b7b90b69207f6802c6bb72d2/sql.bigb">Source code for this page on GitHub</a></div>
<div>Cite with: <a href="https://zenodo.org/badge/latestdoi/16453261">this DOI</a></div>
<div><img src="https://raw.githubusercontent.com/cirosantilli/media/master/ID_photo_of_Ciro_Santilli_taken_in_2013_left_eye_200_100.jpg" loading="lazy" alt="ID photo of Ciro Santilli taken in 2013 right eye"></div>
</footer>
<script>
window.ourbigbook_split_headers = true;
window.ourbigbook_html_x_extension = false;
window.ourbigbook_redirect_prefix = "";
</script>
<script src="../../../../_obb/dist/ourbigbook_runtime.js"></script><script>ourbigbook_runtime.ourbigbook_runtime()</script><script src="../../../../_raw/main.js"></script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-47867706-1', 'auto');
ga('send', 'pageview');
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DEE2HEJW9X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DEE2HEJW9X');
</script>
<script src="https://giscus.app/client.js"
        data-repo="cirosantilli/cirosantilli.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNjQ1MzI2MQ=="
        data-category="giscus"
        data-category-id="DIC_kwDOAPsOjc4CZ6zZ"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark_high_contrast"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</body>
</html>
