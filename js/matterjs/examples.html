<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>hello</title>
<script src="node_modules/matter-js/build/matter.js"></script>
</head>
<body>
<h1 id="title"></h1>
<div id="demo"></div>
<div id="doc">
<p>
Global shortcuts: r: restart scenario, n: next scenario, p: previous scenario
</p>
</div>
<script>
window.Matter || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js" integrity="sha512-0z8URjGET6GWnS1xcgiLBZBzoaS8BNlKayfZyQNKz4IRp+s7CKXx0yz7Eco2+TcwoeMBa5KMwmTX7Kus7Fa5Uw==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>')
</script>
<script>
// Globals
const demoElement = document.getElementById('demo')
const titleElement = document.getElementById('title')
let scenarioIdx = 0
let engine
let render
const idToScenario = {}

// Matter.js global singletons
const Engine = Matter.Engine
const Render = Matter.Render
const Runner = Matter.Runner
const Bodies = Matter.Bodies
const Composite = Matter.Composite
const World = Matter.World

// Scenarios.
const scenarios = [
  {
    id: 'boxes1',
    setup: (engine) => {
      const boxA = Bodies.rectangle(400, 200, 80, 80)
      const boxB = Bodies.rectangle(450, 50, 80, 80)
      const ground = Bodies.rectangle(400, 610, 810, 60, { isStatic: true })
      Composite.add(engine.world, [boxA, boxB, ground])
    },
  },
  {
    id: 'boxes2',
    setup: (engine) => {
      const boxA = Bodies.rectangle(400, 50, 80, 80)
      const boxB = Bodies.rectangle(450, 200, 80, 80)
      const boxC = Bodies.rectangle(650, 200, 80, 80)
      const ground = Bodies.rectangle(400, 610, 810, 60, { isStatic: true })
      Composite.add(engine.world, [boxA, boxB, boxC, ground])
    }
  }
]
for (let i = 0; i < scenarios.length; i++) {
  const scenario = scenarios[i]
  idToScenario[scenario.id] = scenario
  scenario.idx = i
}
if (window.location.hash) {
  const scenario = idToScenario[window.location.hash.substr(1)]
  if (scenario) {
    scenarioIdx = scenario.idx
  }
}

function run(element, scenarioIdx) {
  const engine = Engine.create()
  const render = Render.create({
    element,
    engine,
  })
  const scenario = scenarios[scenarioIdx]
  const title = `${scenarioIdx}: ${scenario.id} - Matter.js demo`
  window.location.hash = scenario.id
  titleElement.innerHTML = title
  document.title = title
  scenario.setup(engine)
  Render.run(render)
  Runner.run(Runner.create(), engine)
  return [engine, render]
}

function reset(element, render, engine, scenarioIdx) {
  // https://github.com/liabru/matter-js/issues/564
  Render.stop(render)
  World.clear(engine.world)
  Engine.clear(engine)
  render.canvas.remove()
  render.canvas = null
  render.context = null
  render.textures = {}

  return run(element, scenarioIdx)
}

document.addEventListener('keydown', (e) => {
  if (e.code === "ArrowUp") {
  } else if (e.code === "ArrowDown") {
  } else if (e.code === "KeyN") {
    scenarioIdx = (scenarioIdx + 1) % scenarios.length
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  } else if (e.code === "KeyR") {
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  } else if (e.code === "KeyP") {
    scenarioIdx--
    if (scenarioIdx === -1) {
      scenarioIdx = scenarios.length - 1
    }
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  }
});
;[engine, render] = run(demoElement, scenarioIdx)
</script>
</body>
</html>
