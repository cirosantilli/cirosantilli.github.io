<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>
<script src="node_modules/matter-js/build/matter.js"></script>
</head>
<body>
<h1 id="title"></h1>
<div id="demo"></div>
<div id="demo-doc"></div>
<div id="doc">
<p>Global shortcuts: R: restart scenario | N: next scenario | P: previous scenario</p>
<p><a href="http://cirosantilli.com/_file/js/matterjs/example.html">More information.</a></p>
</div>
<div id="demo-debug"></div>
<script>
window.Matter || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js" integrity="sha512-0z8URjGET6GWnS1xcgiLBZBzoaS8BNlKayfZyQNKz4IRp+s7CKXx0yz7Eco2+TcwoeMBa5KMwmTX7Kus7Fa5Uw==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>')
</script>
<script>
// Globals
const demoElement = document.getElementById('demo')
const demoDocElement = document.getElementById('demo-doc')
const demoDebugElement = document.getElementById('demo-debug')
const titleElement = document.getElementById('title')
let scenarioIdx = 0
let engine
let render
const idToScenario = {}
const keysDown = new Set()
document.addEventListener('keydown', e => {
  if (e.repeat) { return }
  if (e.code === "ArrowUp") {
  } else if (e.code === "ArrowDown") {
  } else if (e.code === "KeyN") {
    scenarioIdx = (scenarioIdx + 1) % scenarios.length
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  } else if (e.code === "KeyR") {
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  } else if (e.code === "KeyP") {
    scenarioIdx--
    if (scenarioIdx === -1) {
      scenarioIdx = scenarios.length - 1
    }
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  } else {
    keysDown.add(e.code);
  }
})
document.addEventListener('keyup', e => {
  keysDown.delete(e.code)
})
const globalKeyHandlers = {
  KeyN: () => {
    scenarioIdx = (scenarioIdx + 1) % scenarios.length
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  },
  KeyR: () => {
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  },
  KeyP: () => {
    scenarioIdx--
    if (scenarioIdx === -1) {
      scenarioIdx = scenarios.length - 1
    }
    ;[engine, render] = reset(demoElement, render, engine, scenarioIdx)
  },
}


// Matter.js global singletons
const Engine = Matter.Engine
const Render = Matter.Render
const Runner = Matter.Runner
const Bodies = Matter.Bodies
const Composite = Matter.Composite
const World = Matter.World

// Scenarios.
const scenarios = [
  {
    id: 'falling-boxes-1',
    scene: () => {
      return {
        setup: (engine, render) => {
          const boxA = Bodies.rectangle(400, 200, 80, 80)
          const boxB = Bodies.rectangle(450, 50, 80, 80)
          const ground = Bodies.rectangle(400, 610, 810, 60, { isStatic: true })
          Composite.add(engine.world, [boxA, boxB, ground])
        },
      }
    },
  },
  {
    id: 'falling-boxes-2',
    scene: () => {
      return {
        setup: (engine, render) => {
          const boxA = Bodies.rectangle(400, 50, 80, 80)
          const boxB = Bodies.rectangle(450, 200, 80, 80)
          const boxC = Bodies.rectangle(650, 200, 80, 80)
          const ground = Bodies.rectangle(400, 610, 810, 60, { isStatic: true })
          Composite.add(engine.world, [boxA, boxB, boxC, ground])
        }
      }
    },
  },
  {
    id: 'sprites',
    scene: () => {
      return {
        // https://stackoverflow.com/questions/22686917/matter-js-change-colors
        renderOpts: { wireframes: false },
        setup: (engine, render) => {
          // By default it loops over some default colors.
          const boxA = Bodies.rectangle(100, 200, 80, 80)
          const boxB = Bodies.rectangle(200, 200, 80, 80)

          const fixedColor = Bodies.rectangle(300, 200, 80, 80, {
            render: {
              fillStyle: 'green',
              strokeStyle: 'yellow',
              lineWidth: 10,
            },
          })

          const ciro = Bodies.rectangle(
            400, 200, 80, 80,
            {
              render: {
                sprite: {
                  texture: 'https://raw.githubusercontent.com/cirosantilli/media/master/ID_photo_of_Ciro_Santilli_taken_in_2013_square_398.jpg',
                  // TODO set width/height exactly in pixels to make it more easily match the box?
                  // https://github.com/liabru/matter-js/issues/120
                  // https://stackoverflow.com/questions/30678438/matter-js-sprite-size
                  xScale: 80/400,
                  yScale: 80/400,
                }
              }
            }
          )
          const ground = Bodies.rectangle(400, 610, 810, 60, {
            isStatic: true,
            render: {
              fillStyle: 'brown',
            },
          })
          Composite.add(engine.world, [boxA, boxB, fixedColor, ciro, ground])
        },
      }
    },
  },
  {
    id: 'top-down-asdw-fixed-viewport',
    scene: () => {
      const w = 600
      const h = 600

      // Ciro
      const moveForce = 0.01
      const ciroScale = 0.1
      const ciroW = w * ciroScale
      const ciroH = h * ciroScale
      const ciro = Bodies.rectangle(
        w/2, h/2, ciroW, ciroH,
        {
          density: 0.001,
          friction: 0,
          frictionAir: 0.04,
          render: {
            sprite: {
              texture: 'https://raw.githubusercontent.com/cirosantilli/media/master/ID_photo_of_Ciro_Santilli_taken_in_2013_square_398.jpg',
              xScale: ciroW/400,
              yScale: ciroH/400,
            }
          }
        }
      )

      // Wall
      const wallExtra = 0.1
      const wallOpts = {
        isStatic: true,
        render: { fillStyle: 'brown', },
      }

      demoDocElement.innerHTML = '<p>Shortcuts: W: up | S: down | A: left | D: right</p>'

      return {
        beforeUpdate: () => {
          demoDebugElement.innerHTML = `<p>` +
            `x: ${ciro.position.x.toFixed(2)} | y: ${ciro.position.y.toFixed(2)}` +
            ` | vx: ${ciro.velocity.x.toFixed(2)} | vy: ${ciro.velocity.y.toFixed(2)}` +
            `</p>`
        },
        // https://stackoverflow.com/questions/29466684/disabling-gravity-in-matter-js
        engineOpts: { gravity: { y: 0 } },
        keyHandlers: {
          KeyW: () => {
            Matter.Body.applyForce(ciro, {
              x: ciro.position.x,
              y: ciro.position.y
            }, { x: 0, y: -moveForce } )
          },
          KeyS: () => {
            Matter.Body.applyForce(ciro, {
              x: ciro.position.x,
              y: ciro.position.y
            }, { x: 0, y: moveForce } )
          },
          KeyA: () => {
            Matter.Body.applyForce(ciro, {
              x: ciro.position.x,
              y: ciro.position.y
            }, { x: -moveForce, y: 0 } )
          },
          KeyD: () => {
            Matter.Body.applyForce(ciro, {
              x: ciro.position.x,
              y: ciro.position.y
            }, { x: moveForce, y: 0 } )
          },
        },
        renderOpts: {
          height: w,
          width: h,
          wireframes: false,
        },
        setup: (engine, render) => {
          Render.lookAt(render, {
            min: { x: 0, y: 0 },
            max: { x: w, y: h },
          })
          Composite.add(engine.world, [
            ciro,

            // Walls
            // N
            Bodies.rectangle(w/2, 0, w * (1 + wallExtra), h * wallExtra, wallOpts),
            // S
            Bodies.rectangle(w/2, h, w * (1 + wallExtra), h * wallExtra, wallOpts),
            // W
            Bodies.rectangle(0, h/2, w * wallExtra, h  * (1 + wallExtra), wallOpts),
            // E
            Bodies.rectangle(w, h/2, w * wallExtra, h  * (1 + wallExtra), wallOpts),
          ])
        },
      }
    },
  },
]
for (let i = 0; i < scenarios.length; i++) {
  const scenario = scenarios[i]
  idToScenario[scenario.id] = scenario
  scenario.idx = i
}
if (window.location.hash) {
  const scenario = idToScenario[window.location.hash.substr(1)]
  if (scenario) {
    scenarioIdx = scenario.idx
  }
}

function run(element, scenarioIdx) {
  demoDocElement.innerHTML = ''

  const scenario = scenarios[scenarioIdx]
  const scene = scenario.scene()
  const engine = Engine.create(scene.engineOpts || {})
  const render = Render.create({
    element,
    engine,
    options: scene.renderOpts || {},
  })
  const title = `${scenarioIdx}: ${scenario.id} - Matter.js demo`
  window.location.hash = scenario.id
  titleElement.innerHTML = title
  document.title = title
  scene.setup(engine, render)
  Render.run(render)
  Runner.run(Runner.create(), engine)
  const keyHandlers = Object.assign({}, scene.keyHandlers || {}, globalKeyHandlers)
  Matter.Events.on(engine, 'beforeUpdate', event => {
    scene.beforeUpdate?.()
    ;[...keysDown].forEach(k => {
      keyHandlers[k]?.();
    });
  });
  return [engine, render]
}

function reset(element, render, engine, scenarioIdx) {
  // https://github.com/liabru/matter-js/issues/564
  Render.stop(render)
  World.clear(engine.world)
  Engine.clear(engine)
  render.canvas.remove()
  render.canvas = null
  render.context = null
  render.textures = {}
  Matter.Events.off(engine, 'beforeUpdate')

  return run(element, scenarioIdx)
}
;[engine, render] = run(demoElement, scenarioIdx)
</script>
</body>
</html>
